from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from bot.db import connect
import openai
import os

router = Router()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
openai.api_key = os.getenv("OPENAI_API_KEY")


@router.message(Command("start"))
async def start_cmd(message: types.Message):
    conn = await connect()
    user = await conn.fetchrow("SELECT * FROM users WHERE id = $1", message.from_user.id)
    await conn.close()

    if not user:
        await message.answer(
            "üîí –î–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è —Å –±–æ—Ç–æ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.\n"
            "–î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /register"
        )
        return

    await message.answer(
        f"–ü—Ä–∏–≤–µ—Ç, {user['name']}! üëã\n"
        "–Ø ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n"
        "–ú–æ–∂–µ—à—å —Å–ø—Ä–æ—Å–∏—Ç—å –º–µ–Ω—è –æ –ø–∏—Ç–∞–Ω–∏–∏, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, —Å–Ω–µ –∏–ª–∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ üí™"
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥)
@router.message(F.text)
async def chat_with_ai(message: types.Message, state: FSMContext):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
    user_state = await state.get_state()
    if user_state is not None:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π FSM ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        return

    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if message.text.startswith("/"):
        return

    conn = await connect()
    user = await conn.fetchrow("SELECT * FROM users WHERE id = $1", message.from_user.id)
    await conn.close()

    if not user:
        await message.answer("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /register.")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç
    system_prompt = f"""
–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–æ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏.

üìã –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –ò–º—è: {user['name']}
- –í–æ–∑—Ä–∞—Å—Ç: {user['age']}
- –ü–æ–ª: {user['sex']}
- –¶–µ–ª—å: {user['fitness_goal']}
- –†–æ—Å—Ç: {user['height_cm']} —Å–º
- –í–µ—Å: {user['weight_kg']} –∫–≥
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {user['activity_level']}
- –û–ø—ã—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {user['experience_level']}
- –¢—Ä–∞–≤–º—ã: {user['injury_info'] or '–Ω–µ—Ç'}
- –ó–∞–±–æ–ª–µ–≤–∞–Ω–∏—è: {user['health_conditions'] or '–Ω–µ—Ç'}

üéØ –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ—Å—Ç–∏–≥–∞—Ç—å –µ–≥–æ —Ü–µ–ª–µ–π (–Ω–∞–±–æ—Ä, –ø–æ—Ö—É–¥–µ–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ).
2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—Ç–æ—á–Ω–∏–ª, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –æ–Ω –≥–æ—Ç–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ—Å–∏.
3. –ï—Å–ª–∏ —Ü–µ–ª—å –∏–∑–≤–µ—Å—Ç–Ω–∞, –ø–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω: –ø–∏—Ç–∞–Ω–∏–µ, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.
4. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–µ–π—Å—Ç–≤–∏—è: —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –ø—Ä–∏–≤—ã—á–∫–∏, —à–∞–≥–∏ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã.
5. –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∞–≤–º—ã –∏–ª–∏ –±–æ–ª–µ–∑–Ω–∏ ‚Äî —É—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ –ø—Ä–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö, –∏–∑–±–µ–≥–∞–π –≤—Ä–µ–¥–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.
6. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ–º–æ–≥–∞–π —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏.

üß† –ü–æ–≤–µ–¥–µ–Ω–∏–µ:
- –°–ø—Ä–∞—à–∏–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–∞–ª–æ.
- –•—Ä–∞–Ω–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç–æ–Ω.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∞—É—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã ‚Äî –æ–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏.
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π OpenAI, ChatGPT –∏–ª–∏ –ò–ò.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ö–æ–¥–∏—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É (–ª–∏—á–Ω–æ–µ, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è –∏ —Ç.–¥.) ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π –∫ —Ç–µ–º–µ –∑–¥–æ—Ä–æ–≤—å—è –∏ —Ñ–∏—Ç–Ω–µ—Å–∞.
- –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, 2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ –±—É–¥—å –∫–∞–∫ –ª–∏—á–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä, –Ω–µ –∫–∞–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç.

üí¨ –ü—Ä–∏–º–µ—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç ¬´–Ø –Ω–µ –∑–Ω–∞—é, —á—Ç–æ –¥–µ–ª–∞—Ç—å¬ª ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏, —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ª—ë–≥–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
- –ï—Å–ª–∏ –ø–∏—à–µ—Ç ¬´–°–æ—Å—Ç–∞–≤—å –º–Ω–µ –ø–ª–∞–Ω¬ª ‚Äî —É—Ç–æ—á–Ω–∏, —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é –æ–Ω —Ö–æ—á–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –≤ –∫–∞–∫–∏–µ –¥–Ω–∏.
- –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç ¬´—á—Ç–æ –ø–æ –ø–∏—Ç–∞–Ω–∏—é¬ª ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ—Å—Ç—É—é, –ø–æ–Ω—è—Ç–Ω—É—é —Å—Ö–µ–º—É –±–µ–∑ —Å—Ç—Ä–æ–≥–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
"""

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": message.text},
            ]
        )

        answer = response.choices[0].message.content
        await message.answer(answer)

    except Exception as e:
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        print("–û—à–∏–±–∫–∞ OpenAI:", e)